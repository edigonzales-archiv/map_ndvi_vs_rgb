<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">

        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"> 
        <style  type="text/css">
            html, body, .map {
                padding: 0;
                width: 100%;
                height: 100%;
                position: relative;
                margin: 0 auto;
                overflow: hidden;
            }
            
            #layer-select {
                right: 1em;
                top: 2em;
                position: absolute;
                width: 160px;
            }
        </style>
        <title>NDVI versus RGB</title>
    </head>
    <body>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>        
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="http://api3.geo.admin.ch/loader.js?lang=en" type="text/javascript"></script>
                

        <div id="map" class="map">
        </div>

        <select id="layer-select" class="form-control">
        </select>
        
        
        <script type="text/javascript">
        

                        
            //console.log(egid);
                
 
        
            
            // Create the map
            
            // GeoAdmin
            /*
            var layer = ga.layer.create('ch.swisstopo.pixelkarte-farbe');
            var map = new ga.Map({
                target: document.getElementById('map'),
                layers: [layer, vectorLayer],
                view: new ol.View2D({
                    resolution: 750,
                    center: [660000, 180000]
                })
            });
            */
            
            // SOGIS
            var projection = ol.proj.configureProj4jsProjection({
                code: 'EPSG:21781',
                extent: [420000, 30000, 900000, 350000]
            });
            
            var projectionExtent = projection.getExtent();
            var zoomLevels = 29;
            var resolutions = [4000,3750,3500,3250,3000,2750,2500,2250,2000,1750,1500,1250,1000,750,650,500,250,100,50,20,10,5,2.5,2,1.5,1,0.5,0.25,0.1];
            var matrixIds = new Array(zoomLevels);
            
            for (var z = 0; z < zoomLevels; ++z) {
                matrixIds[z] = z;
            }            
            
            var layer = new ol.layer.Image({
                source: new ol.source.ImageWMS({
                    url: 'http://www.sogis1.so.ch/cgi-bin/sogis/sogis_strassenkarte.wms',
                    params: {'LAYERS': 'strassenkarte_no_ortho'},
                })
            });        
            
            
            var layerRGB = new ol.layer.Tile({
                layerName: "Orthofoto RGB",
                layerId: "orthofoto_rgb",
                baselayer: true,                
                visible: false,
                source: new ol.source.WMTS({
                    //url: 'http://www.catais.org/mapcache/wmts',
                    url: "http://www.catais.org/mapcache/wmts/1.0.0/{Layer}/default/21781/" + "{TileMatrix}/{TileRow}/{TileCol}",
                    layer: 'ch.so.agi.orthofoto',
                    requestEncoding: 'REST',                    
                    matrixSet: '21781',
                    format: 'image/jpeg',
                    projection: projection,
                    tileGrid: new ol.tilegrid.WMTS({
                        origin: ol.extent.getTopLeft(projectionExtent),
                        resolutions: resolutions,
                        matrixIds: matrixIds
                    }),

                    //extent: [590000, 210000, 645000, 262000],
                    style: 'default'
                })
            });
            
            var layerNDVI = new ol.layer.Tile({
                layerName: "Orthofoto NDVI",
                layerId: "orthofoto_ndvi",
                baselayer: true,                
                visible: true,
                source: new ol.source.WMTS({
                    //url: 'http://www.catais.org/mapcache/wmts',
                    url: "http://www.catais.org/mapcache/wmts/1.0.0/{Layer}/default/21781/" + "{TileMatrix}/{TileRow}/{TileCol}",
                    layer: 'ch.so.agi.orthofoto-ndvi',
                    requestEncoding: 'REST',                    
                    matrixSet: '21781',
                    format: 'image/jpeg',
                    projection: projection,
                    tileGrid: new ol.tilegrid.WMTS({
                        origin: ol.extent.getTopLeft(projectionExtent),
                        resolutions: resolutions,
                        matrixIds: matrixIds
                    }),

                    //extent: [590000, 210000, 645000, 262000],
                    style: 'default'
                })
            });            
            
            var map = new ol.Map({
                renderer: 'canvas',
                //renderer: 'dom',
                controls: ol.control.defaults().extend([
                    //new ol.control.FullScreen(), 
                    new ol.control.ScaleLine({
                        units: 'metric'
                    })
                ]),
                ol3Logo: false,
                target: document.getElementById('map'),
                layers: [
                    layerNDVI, layerRGB
                ],  
                view: new ol.View2D({
                    projection: projection,
                    center: [607100, 226700],
                    zoom: 18,
                    resolutions: [4000,3750,3500,3250,3000,2750,2500,2250,2000,1750,1500,1250,1000,750,650,500,250,100,50,20,10,5,2.5,2,1.5,1,0.5,0.25,0.1,0.05]
                    // Komisch, so funktionierts nicht. Dh. bei einigen Zoomlevels
                    // wird immer wieder 'serverVector' neu initialisiert -> Abfrage
                    // des EGID -> zentrieren der Karte.
                    // Hat vielleicht auch damit zu tun, dass ich ol3 von swisstopo
                    // verwende? 
                    //zoom: 25,
                    //resolutions: [4000,3750,3500,3250,3000,2750,2500,2250,2000,1750,1500,1250,1000,750,650,500,250,100,50,20,10,5,2.5,2,1.5,1,0.5,0.25,0.1,0.05]
                })
            });  
            
            map.getLayers().getArray().forEach(function(layer){
                var bgLayerName = layer.get("layerName");
                var bgLayerId = layer.get("layerId");
                var isBaseLayer = layer.get("baselayer");
                if (isBaseLayer) {
                    $('#layer-select').append('<option value=' + bgLayerId + '>' + bgLayerName + '</option>');          
                }
                
            });
            $('#layer-select').append('<option value="">kein Hintergrund</option>');
            
            $('#layer-select').change(function() {
                var selectedBgLayerId = $(this).find(':selected').val();
                map.getLayers().getArray().forEach(function(layer){
                    var isBaseLayer = layer.get("baselayer");
                    if (isBaseLayer) {
                        if (selectedBgLayerId == layer.get("layerId")) {
                            layer.setVisible(true);
                        } else {
                            layer.setVisible(false);
                        }
                    }
                });
            });
            $('#layer-select').trigger('change'); 
            
            
        </script>
    </body>
</html>